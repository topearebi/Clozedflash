<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlashDeck v7</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="dexie.js"></script>
    <script src="jszip.min.js"></script>
    
    <script src="script.js" defer></script>
</head>
<body>

    <div class="app-container">
        
        <header>
            <div class="brand">
                <h1>FlashDeck <span class="version">v7</span></h1>
            </div>
            <div class="header-controls">
                <div class="stat-pill" title="Current Streak">üî• <span id="stat-streak">0</span></div>
                <div class="stat-pill" title="Level">‚≠ê <span id="stat-level">1</span></div>
                <div class="currency-display" title="Sparks">‚ö° <span id="credit-count">0</span></div>
            </div>
        </header>

        <section id="view-home" class="active-view">
            
            <div class="daily-stats-row">
                <div class="mini-stat">
                    <span class="ms-label">Reviewed</span>
                    <span class="ms-val" id="daily-reviews">0</span>
                </div>
                <div class="mini-stat">
                    <span class="ms-label">Learned</span>
                    <span class="ms-val" id="daily-learned">0</span>
                </div>
                <div class="mini-stat">
                    <span class="ms-label">Mastered</span>
                    <span class="ms-val" id="total-mastered">0</span>
                </div>
            </div>

            <div class="stats-box">
                <h2 id="status-heading">Loading...</h2>
                <div class="big-number" id="dashboard-count">0</div>
                <div class="action-row">
                    <button id="btn-action-main" class="primary-btn">Loading...</button> 
                    <button id="btn-game" class="secondary-btn game-btn">Speed Round <span class="cost-tag">+Earn</span></button>
                </div>
            </div>
            
            <div class="section-title"><h3>Recent Activity</h3></div>
            <div id="home-activity-list" class="simple-list"></div>
        </section>

        <section id="view-read" class="hidden-view">
            <div class="nav-bar">
                <h2>Library</h2>
                <div class="nav-actions">
                    <button id="btn-import-chapter" class="secondary-btn small-btn">Import Text</button>
                    <button id="btn-new-chapter" class="primary-btn small-btn">+ New</button>
                </div>
            </div>
            <div id="chapter-list" class="scroll-list"></div>
        </section>

        <section id="view-browse" class="hidden-view">
            <div class="nav-bar">
                <h2>My Cards</h2>
                <div class="nav-actions">
                    <button id="btn-add-card" class="fab-mini">+</button>
                </div>
            </div>
            <div class="search-row">
                <input type="text" id="search-bar" placeholder="Search cards by text...">
            </div>
            <div id="card-list" class="scroll-list"></div>
        </section>

        <section id="view-settings" class="hidden-view">
            <h2>Settings</h2>
            <div class="settings-content">
                <button id="btn-open-import" class="secondary-btn">Bulk Import Cards</button>
                <button id="btn-backup" class="secondary-btn">Download Full Backup (.json)</button>
                <button id="btn-clear-db" class="danger-btn">Reset Database</button>
                <div class="info-block">
                    <p><strong>XP Progress:</strong> <span id="setting-xp">0</span> XP</p>
                    <p class="small-text">Data stored locally in IndexedDB. Works offline.</p>
                </div>
            </div>
        </section>

        <nav class="bottom-nav">
            <button class="nav-item active" data-target="view-home">üè† Home</button>
            <button class="nav-item" data-target="view-read">üìñ Read</button>
            <button class="nav-item" data-target="view-browse">üóÇÔ∏è Browse</button>
            <button class="nav-item" data-target="view-settings">‚öôÔ∏è Config</button>
        </nav>

        <div id="modal-import" class="modal hidden">
            <div class="modal-content">
                <h3>Import Cards</h3>
                <p class="small-text">Paste Excel/CSV. Added to <b>New Queue</b>.</p>
                <p class="tiny-text">Format: <code>Target [TAB] Meta [TAB] Native</code></p>
                <input type="text" id="input-bulk-tag" placeholder="Tag (e.g. French)">
                <textarea id="input-bulk" placeholder="Paste data here..."></textarea>
                <div class="modal-actions">
                    <button id="btn-cancel-import" class="secondary-btn">Cancel</button>
                    <button id="btn-run-import" class="primary-btn">Import Cards</button>
                </div>
            </div>
        </div>

        <div id="modal-import-chapter" class="modal hidden">
            <div class="modal-content">
                <h3>Import Chapter</h3>
                <p class="small-text">Creates a chapter with segments.</p>
                <input type="text" id="imp-chap-title" placeholder="Title (e.g. Harry Potter Ch1)">
                <input type="text" id="imp-chap-tag" placeholder="Language Tag">
                <textarea id="imp-chap-data" placeholder="Paste text here..." style="height:150px;"></textarea>
                <div class="modal-actions">
                    <button id="btn-cancel-imp-chap" class="secondary-btn">Cancel</button>
                    <button id="btn-run-imp-chap" class="primary-btn">Import Chapter</button>
                </div>
            </div>
        </div>

        <div id="overlay-study" class="overlay hidden">
            <div class="overlay-header">
                <button id="btn-quit-study" class="text-btn">Quit</button>
                <span id="study-mode-badge" class="tag">Review</span>
                <span id="study-progress">1 / 10</span>
            </div>
            <div class="card-area">
                <div id="study-tag-badge" class="tag-badge hidden">TAG</div>
                <div id="study-question">
                    <span class="hint-text" id="study-hint-label">...</span>
                    <h3 id="study-main-text">...</h3>
                    <button id="btn-play-audio" class="audio-btn">üîä</button>
                    <button id="btn-show-hint" class="text-btn hidden">Show Hint</button>
                    <p id="study-sub-text" class="hidden">...</p>
                </div>
                <div id="study-cloze-area" class="hidden">
                    <input type="text" id="cloze-answer" placeholder="Type answer..." autocomplete="off">
                    <button id="btn-check-cloze" class="secondary-btn">Check</button>
                </div>
                <div id="study-answer" class="hidden">
                    <div class="divider"></div>
                    <div class="answer-box">
                        <h3 id="ans-target">...</h3>
                        <p id="ans-meta" class="meta-text">...</p>
                        <p id="ans-native">...</p>
                    </div>
                    <div class="rating-buttons">
                        <button class="rate-btn" data-rating="0" style="background:#ff6b6b">Again</button>
                        <button class="rate-btn" data-rating="1" style="background:#feca57">Hard</button>
                        <button class="rate-btn" data-rating="2" style="background:#1dd1a1">Good</button>
                        <button class="rate-btn" data-rating="3" style="background:#54a0ff">Easy</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="overlay-builder" class="overlay hidden">
            <div class="overlay-header">
                <button id="btn-quit-builder" class="text-btn">Cancel</button>
                <span>New Chapter</span>
                <button id="btn-save-chapter" class="primary-btn small-btn">Save</button>
            </div>
            <div class="builder-meta">
                <input type="text" id="builder-title" placeholder="Chapter Title">
                <input type="text" id="builder-tag" placeholder="Language Tag">
            </div>
            <div id="builder-stream" class="stream-container">
                <div class="empty-state">Add sentences below to build your story.</div>
            </div>
            <div class="builder-dock">
                <div class="dock-inputs">
                    <input type="text" id="dock-target" placeholder="Target text...">
                    <input type="text" id="dock-native" placeholder="Translation...">
                    <input type="text" id="dock-meta" placeholder="Meta/Pinyin (Opt)">
                </div>
                <div class="dock-controls">
                    <button id="btn-record" class="record-btn">üé§</button>
                    <label class="file-btn">
                        üìÅ <input type="file" id="dock-file" accept="audio/*" hidden>
                    </label>
                    <button id="btn-add-segment" class="primary-btn">‚¨Ü Add</button>
                </div>
                <div id="recording-status" class="hidden">Recording... (Tap to stop)</div>
                <div id="file-status" class="hidden small-text">File selected</div>
            </div>
        </div>

        <div id="overlay-reader" class="overlay hidden">
            <div class="overlay-header">
                <button id="btn-quit-reader" class="text-btn">Close</button>
                <div class="reader-toggles">
                    <button id="btn-toggle-meta" class="toggle-icon">Pinyin</button>
                    <button id="btn-toggle-native" class="toggle-icon">Eng</button>
                </div>
            </div>
            <div id="reader-content" class="reader-body"></div>
            <div id="reader-controls" style="padding:10px; border-top:1px solid #eee; display:flex; gap:10px;">
                <button id="btn-reader-play" class="primary-btn">üîä Play All</button>
            </div>
            <div id="reader-sheet" class="bottom-sheet hidden">
                <div class="sheet-content">
                    <h3 id="sheet-target">Target</h3>
                    <p id="sheet-native">Native</p>
                    <div class="sheet-actions">
                        <button id="btn-sheet-play" class="secondary-btn">üîä</button>
                        <button id="btn-sheet-promote" class="primary-btn">Promote to Card</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-game" class="overlay hidden">
            <div class="overlay-header">
                <button id="btn-quit-game" class="text-btn">Quit</button>
                <span id="game-status" style="font-weight:bold; color: #6c5ce7;">Round 1</span>
            </div>
            <div class="card-area">
                <div id="game-tag-badge" class="tag-badge hidden">TAG</div>
                <div id="game-card-content" class="game-card"></div>
                <div id="game-input-area" class="hidden">
                    <input type="text" id="game-input" placeholder="Type meaning..." autocomplete="off">
                    <div class="game-actions">
                        <button id="btn-game-submit" class="secondary-btn">Submit</button>
                        <button id="btn-game-override" class="text-btn hidden">I was right (Override)</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-add-card" class="modal hidden">
            <div class="modal-content">
                <h3>Card Details</h3>
                <form id="form-quick-add">
                    <input type="text" id="qa-tag" placeholder="Tag (e.g. Mandarin)">
                    <textarea id="qa-target" placeholder="Target" required></textarea>
                    <input type="text" id="qa-meta" placeholder="Meta/Pinyin">
                    <textarea id="qa-native" placeholder="Native" required></textarea>
                    
                    <div class="audio-control-row">
                        <button type="button" id="btn-qa-record" class="secondary-btn">üé§ Record</button>
                        <label class="secondary-btn" style="text-align:center; cursor:pointer;">
                            üìÅ Upload <input type="file" id="qa-file" accept="audio/*" hidden>
                        </label>
                    </div>
                    <span id="qa-audio-status" class="small-text" style="display:block; margin-bottom:10px;">No audio</span>

                    <div class="modal-actions">
                        <button type="button" id="btn-qa-cancel" class="secondary-btn">Cancel</button>
                        <button type="submit" class="primary-btn">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="modal-cram-settings" class="modal hidden">
            <div class="modal-content">
                <h3>Cram Mode</h3>
                <p class="small-text">Cost: <span style="color:#e17055;">50 ‚ö°</span></p>
                <select id="cram-tag-select" style="width:100%; padding:10px; margin:10px 0;">
                    <option value="ALL">All Tags</option>
                </select>
                <div class="toggle-container" style="margin-bottom:20px;">
                    <button id="cram-type-mix" class="toggle-btn active">Mix</button>
                    <button id="cram-type-vocab" class="toggle-btn">Words</button>
                    <button id="cram-type-sentence" class="toggle-btn">Sentences</button>
                </div>
                <div class="modal-actions">
                    <button id="btn-cancel-cram" class="secondary-btn">Cancel</button>
                    <button id="btn-start-cram" class="primary-btn cram-btn">Start</button>
                </div>
            </div>
        </div>

    </div>
</body>
</html>
